# /workspace/yolo/ultralytics/cfg/models/new/yolov12-sod-fusion-v5-E4.yaml
# 作用: 这是为 E4 消融实验定制的 YOLOv5-simple 模型配置。
# E4 目标: 在 E3 的基础上，加入 CBAM_Block 注意力模块。
# 与 E3 的区别: 在 backbone 和 neck 的特定位置重新加入了 CBAM_Block。

nc: 10  # 类别数量 (VisDrone 数据集有 10 类)
depth_multiple: 0.33
width_multiple: 0.50
ch: 3   # 输入通道

# E4 主干网络 (Backbone) - 保留 SE_Block 和 CBAM_Block
backbone:
  # Stage 1
  - [ -1, 1, Conv, [64, 3, 2] ]             # 0: stride 2 conv -> P1/2
  - [ -1, 1, SE_Block, [64] ]               # 1: E4: KEPT SE attention
  - [ -1, 1, Conv, [128, 3, 2] ]            # 2: -> P2/4
  - [ -1, 3, C2f, [128, True] ]             # 3: CSP block (Backbone P2 output)
  - [ -1, 1, CBAM_Block, [128, 16] ]        # 4: E4: KEPT CBAM attention
  - [ -1, 1, Conv, [256, 3, 2] ]            # 5: -> P3/8
  - [ -1, 6, C2f, [256, True] ]             # 6: CSP block (Backbone P3 output)
  - [ -1, 1, Conv, [512, 3, 2] ]            # 7: -> P4/16
  - [ -1, 3, C2f, [512, True] ]             # 8: CSP block (Backbone P4 output)
  # - [ -1, 1, SwinBlock, [4, 7] ]          # E4: REMOVED
  - [ -1, 1, Conv, [1024, 3, 2] ]           # 9: -> P5/32
  - [ -1, 2, C2f, [1024, True] ]            # 10: CSP block
  # - [ -1, 1, A2_Attn, [8, 8] ]            # E4: REMOVED
  - [ -1, 1, SPPF, [1024, 5] ]              # 11: SPPF (Backbone P5 output)

# E4 颈部网络 (Neck) - 保留 SE 和 CBAM, 保留 P2 路径
neck:
  # Top-Down path (PANet)
  # P5 -> P4
  - [ -1, 1, Conv, [512, 1, 1] ]                 # 12: reduce channel
  - [ -1, 1, nn.Upsample, [None, 2, 'nearest'] ]  # 13: upsample
  - [ [ -1, 8 ], 1, Concat, [1] ]                 # 14: concat P5 upsampled with P4 from backbone (new layer 8)
  - [ -1, 3, C2f, [512, True] ]                   # 15: fusion at P4
  - [ -1, 1, CBAM_Block, [512, 16] ]              # 16: E4: KEPT CBAM attention
  
  # P4 -> P3
  - [ -1, 1, Conv, [256, 1, 1] ]                 # 17: reduce channel
  - [ -1, 1, nn.Upsample, [None, 2, 'nearest'] ]  # 18: upsample
  - [ [ -1, 6 ], 1, Concat, [1] ]                 # 19: concat with P3 from backbone (new layer 6)
  - [ -1, 3, C2f, [256, True] ]                   # 20: fusion at P3
  - [ -1, 1, SE_Block, [256] ]                    # 21: E4: KEPT SE attention
  
  # P3 -> P2
  - [ -1, 1, Conv, [128, 1, 1] ]                 # 22: reduce channel
  - [ -1, 1, nn.Upsample, [None, 2, 'nearest'] ]  # 23: upsample
  - [ [ -1, 3 ], 1, Concat, [1] ]                 # 24: concat with P2 from backbone (new layer 3)
  - [ -1, 3, C2f, [128, True] ]                   # 25: fusion at P2 (This is the output for the P2 head)
  # - [ -1, 1, SwinBlock, [2, 7] ]               # E4: REMOVED

  # Bottom-Up path
  # P2 -> P3
  - [ 25, 1, Conv, [256, 3, 2] ]                  # 26: downsample P2->P3, input from P2 fusion (layer 25)
  - [ [ -1, 21 ], 1, Concat, [1] ]                # 27: concat with P3 from top-down path (new layer 21)
  - [ -1, 3, C2f, [256, True] ]                   # 28: fusion at P3 (This is the output for the P3 head)
  # - [ -1, 1, CA_Block, [256] ]                  # E4: REMOVED

  # P3 -> P4
  - [ -1, 1, Conv, [512, 3, 2] ]                  # 29: downsample P3->P4
  - [ [ -1, 16 ], 1, Concat, [1] ]                # 30: concat with P4 from top-down path (new layer 16)
  - [ -1, 3, C2f, [512, True] ]                   # 31: fusion at P4 (This is the output for the P4 head)

  # P4 -> P5
  - [ -1, 1, Conv, [1024, 3, 2] ]                 # 32: downsample P4->P5
  - [ [ -1, 11 ], 1, Concat, [1] ]                # 33: concat with P5 from backbone (new layer 11, after SPPF)
  - [ -1, 2, C2f, [1024, True] ]                  # 34: fusion at P5 (This is the output for the P5 head)

# E4 检测头 (Head) - 使用 P2, P3, P4, P5 四个尺度的输出
head:
  - [ [25, 28, 31, 34], 1, Detect, [nc] ] # Detect from P2(25), P3(28), P4(31), P5(34)