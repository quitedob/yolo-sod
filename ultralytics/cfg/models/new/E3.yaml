# /workspace/yolo/ultralytics/cfg/models/new/yolov12-sod-fusion-v5-E3.yaml
# 作用: 这是为 E3 消融实验定制的 YOLOv5-simple 模型配置。
# E3 目标: 在 E2 的基础上，加入 SE_Block 注意力模块。
# 与 E2 的区别: 在 backbone 和 neck 的特定位置重新加入了 SE_Block。

nc: 10  # 类别数量 (VisDrone 数据集有 10 类)
depth_multiple: 0.33
width_multiple: 0.50
ch: 3   # 输入通道

# E3 主干网络 (Backbone) - 仅保留 SE_Block
backbone:
  # Stage 1
  - [ -1, 1, Conv, [64, 3, 2] ]             # 0: stride 2 conv -> P1/2
  - [ -1, 1, SE_Block, [64] ]               # 1: E3: KEPT SE attention
  - [ -1, 1, Conv, [128, 3, 2] ]            # 2: -> P2/4
  - [ -1, 3, C2f, [128, True] ]             # 3: CSP block (Backbone P2 output)
  # - [ -1, 1, CBAM_Block, [128, 16] ]      # E3: REMOVED
  - [ -1, 1, Conv, [256, 3, 2] ]            # 4: -> P3/8
  - [ -1, 6, C2f, [256, True] ]             # 5: CSP block (Backbone P3 output)
  - [ -1, 1, Conv, [512, 3, 2] ]            # 6: -> P4/16
  - [ -1, 3, C2f, [512, True] ]             # 7: CSP block (Backbone P4 output)
  # - [ -1, 1, SwinBlock, [4, 7] ]          # E3: REMOVED
  - [ -1, 1, Conv, [1024, 3, 2] ]           # 8: -> P5/32
  - [ -1, 2, C2f, [1024, True] ]            # 9: CSP block
  # - [ -1, 1, A2_Attn, [8, 8] ]            # E3: REMOVED
  - [ -1, 1, SPPF, [1024, 5] ]              # 10: SPPF (Backbone P5 output)

# E3 颈部网络 (Neck) - 仅保留 SE_Block，保留 P2 路径
neck:
  # Top-Down path (PANet)
  # P5 -> P4
  - [ -1, 1, Conv, [512, 1, 1] ]                 # 11: reduce channel
  - [ -1, 1, nn.Upsample, [None, 2, 'nearest'] ]  # 12: upsample
  - [ [ -1, 7 ], 1, Concat, [1] ]                 # 13: concat P5 upsampled with P4 from backbone (new layer 7)
  - [ -1, 3, C2f, [512, True] ]                   # 14: fusion at P4
  # - [ -1, 1, CBAM_Block, [512, 16] ]           # E3: REMOVED
  
  # P4 -> P3
  - [ -1, 1, Conv, [256, 1, 1] ]                 # 15: reduce channel
  - [ -1, 1, nn.Upsample, [None, 2, 'nearest'] ]  # 16: upsample
  - [ [ -1, 5 ], 1, Concat, [1] ]                 # 17: concat with P3 from backbone (new layer 5)
  - [ -1, 3, C2f, [256, True] ]                   # 18: fusion at P3
  - [ -1, 1, SE_Block, [256] ]                    # 19: E3: KEPT SE attention
  
  # P3 -> P2
  - [ -1, 1, Conv, [128, 1, 1] ]                 # 20: reduce channel
  - [ -1, 1, nn.Upsample, [None, 2, 'nearest'] ]  # 21: upsample
  - [ [ -1, 3 ], 1, Concat, [1] ]                 # 22: concat with P2 from backbone (new layer 3)
  - [ -1, 3, C2f, [128, True] ]                   # 23: fusion at P2 (This is the output for the P2 head)
  # - [ -1, 1, SwinBlock, [2, 7] ]               # E3: REMOVED

  # Bottom-Up path
  # P2 -> P3
  - [ 23, 1, Conv, [256, 3, 2] ]                  # 24: downsample P2->P3, input from P2 fusion (layer 23)
  - [ [ -1, 19 ], 1, Concat, [1] ]                # 25: concat with P3 from top-down path (new layer 19)
  - [ -1, 3, C2f, [256, True] ]                   # 26: fusion at P3 (This is the output for the P3 head)
  # - [ -1, 1, CA_Block, [256] ]                  # E3: REMOVED

  # P3 -> P4
  - [ -1, 1, Conv, [512, 3, 2] ]                  # 27: downsample P3->P4
  - [ [ -1, 14 ], 1, Concat, [1] ]                # 28: concat with P4 from top-down path (new layer 14)
  - [ -1, 3, C2f, [512, True] ]                   # 29: fusion at P4 (This is the output for the P4 head)

  # P4 -> P5
  - [ -1, 1, Conv, [1024, 3, 2] ]                 # 30: downsample P4->P5
  - [ [ -1, 10 ], 1, Concat, [1] ]                # 31: concat with P5 from backbone (new layer 10, after SPPF)
  - [ -1, 2, C2f, [1024, True] ]                  # 32: fusion at P5 (This is the output for the P5 head)

# E3 检测头 (Head) - 使用 P2, P3, P4, P5 四个尺度的输出
head:
  - [ [23, 26, 29, 32], 1, Detect, [nc] ] # Detect from P2(23), P3(26), P4(29), P5(32)